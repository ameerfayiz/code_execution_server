// index.html
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Execution Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 20px;
            padding-bottom: 40px;
        }

        .CodeMirror {
            height: 300px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .output-container {
            min-height: 150px;
            max-height: 300px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            white-space: pre-wrap;
        }

        .spinner-border {
            display: none;
        }

        .interactive-input-container {
            display: none;
            margin-top: 10px;
        }

        .interactive-input {
            font-family: monospace;
        }

        .output-container.running {
            border-color: #0d6efd;
            background-color: #f0f7ff;
        }

        .stderr {
            color: #dc3545;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="mb-4">Code Execution Platform</h1>

        <div class="row mb-3">
            <div class="col-md-6">
                <label for="language" class="form-label">Language</label>
                <select id="language" class="form-select">
                    <option value="python">Python</option>
                    <option value="javascript">JavaScript</option>
                    <option value="java">Java</option>
                    <option value="cpp">C++</option>
                    <option value="ruby">Ruby</option>
                    <option value="go">Go</option>
                    <option value="dart">Dart</option>
                    <option value="php">PHP</option>
                </select>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-12">
                <label for="code-editor" class="form-label">Code</label>
                <textarea id="code-editor"></textarea>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-12">
                <button id="run-btn" class="btn btn-primary">
                    <span id="run-spinner" class="spinner-border spinner-border-sm" role="status"
                        aria-hidden="true"></span>
                    Run Code (Interactive)
                </button>
                <button id="stop-btn" class="btn btn-danger ms-2" style="display: none;">Stop</button>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-12">
                <label for="output" class="form-label">Output</label>
                <div id="output" class="output-container"></div>
                <div class="interactive-input-container" id="input-container">
                    <div class="input-group">
                        <input type="text" id="interactive-input" class="form-control interactive-input"
                               placeholder="Type input and press Enter..." autocomplete="off">
                        <button class="btn btn-outline-primary" id="send-input-btn">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/clike/clike.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/ruby/ruby.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/go/go.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/php/php.min.js"></script>
    <script>
        // Initialize CodeMirror
        const codeEditor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
            lineNumbers: true,
            mode: 'python',
            theme: 'dracula',
            indentUnit: 4,
            tabSize: 4,
            indentWithTabs: false,
            smartIndent: true,
            lineWrapping: true,
            extraKeys: {
                "Tab": function (cm) {
                    if (cm.somethingSelected()) {
                        cm.indentSelection("add");
                    } else {
                        cm.replaceSelection("    ", "end", "+input");
                    }
                }
            }
        });

        // Sample code for each language
        const sampleCode = {
            python: `# Python Example
print("Hello, World!")
name = input("Enter your name: ")
print(f"Hello, {name}!")

# Calculate the sum of numbers from 1 to 10
total = sum(range(1, 11))
print(f"Sum of numbers from 1 to 10: {total}")`,

            javascript: `// JavaScript Example
console.log("Hello, World!");

// Read input
const readline = require('readline').createInterface({
  input: process.stdin,
  output: process.stdout
});

readline.question('Enter your name: ', name => {
  console.log(\`Hello, \${name}!\`);
  
  // Calculate the sum of numbers from 1 to 10
  let total = 0;
  for (let i = 1; i <= 10; i++) {
    total += i;
  }
  console.log(\`Sum of numbers from 1 to 10: \${total}\`);
  
  readline.close();
  process.stdin.unref(); // Allow process to exit when readline closes
});`,

            java: `// Java Example
import java.util.Scanner;

public class Main {
    public static void main(String[] args) {
        System.out.println("Hello, World!");
        
        Scanner scanner = new Scanner(System.in);
        System.out.print("Enter your name: ");
        String name = scanner.nextLine();
        System.out.println("Hello, " + name + "!");
        
        // Calculate the sum of numbers from 1 to 10
        int total = 0;
        for (int i = 1; i <= 10; i++) {
            total += i;
        }
        System.out.println("Sum of numbers from 1 to 10: " + total);
        
        scanner.close();
    }
}`,

            cpp: `// C++ Example
#include <iostream>
#include <string>

int main() {
    std::cout << "Hello, World!" << std::endl;
    
    std::string name;
    std::cout << "Enter your name: ";
    std::getline(std::cin, name);
    std::cout << "Hello, " << name << "!" << std::endl;
    
    // Calculate the sum of numbers from 1 to 10
    int total = 0;
    for (int i = 1; i <= 10; i++) {
        total += i;
    }
    std::cout << "Sum of numbers from 1 to 10: " << total << std::endl;
    
    return 0;
}`,

            ruby: `# Ruby Example
# Disable output buffering for interactive input
STDOUT.sync = true

puts "Hello, World!"

print "Enter your name: "
STDOUT.flush
name = $stdin.gets.chomp
puts "Hello, #{name}!"

# Calculate the sum of numbers from 1 to 10
total = (1..10).sum
puts "Sum of numbers from 1 to 10: #{total}"`,

            go: `// Go Example
package main

import (
	"bufio"
	"fmt"
	"os"
	"strings"
)

func main() {
	fmt.Println("Hello, World!")
	
	reader := bufio.NewReader(os.Stdin)
	fmt.Print("Enter your name: ")
	name, _ := reader.ReadString('\\n')
	name = strings.TrimSpace(name)
	fmt.Printf("Hello, %s!\\n", name)
	
	// Calculate the sum of numbers from 1 to 10
	total := 0
	for i := 1; i <= 10; i++ {
		total += i
	}
	fmt.Printf("Sum of numbers from 1 to 10: %d\\n", total)
}`,

            dart: `// Dart Example
import 'dart:io';

void main() {
  print('Hello, World!');
  
  stdout.write('Enter your name: ');
  String? name = stdin.readLineSync();
  print('Hello, \${name ?? "User"}!');
  
  // Calculate the sum of numbers from 1 to 10
  int total = 0;
  for (int i = 1; i <= 10; i++) {
    total += i;
  }
  print('Sum of numbers from 1 to 10: \$total');
}`,

            php: `<?php
// PHP Example
echo "Hello, World!\\n";

echo "Enter your name: ";
$name = trim(fgets(STDIN));
echo "Hello, " . $name . "!\\n";

// Calculate the sum of numbers from 1 to 10
$total = 0;
for ($i = 1; $i <= 10; $i++) {
    $total += $i;
}
echo "Sum of numbers from 1 to 10: " . $total . "\\n";
?>`
        };

        // Language mode mapping
        const languageModes = {
            python: 'python',
            javascript: 'javascript',
            java: 'text/x-java',
            cpp: 'text/x-c++src',
            ruby: 'ruby',
            go: 'go',
            dart: 'text/x-dart',
            php: 'text/x-php'
        };

        // Set initial code sample
        codeEditor.setValue(sampleCode.python);

        // Handle language change
        document.getElementById('language').addEventListener('change', function () {
            const language = this.value;
            codeEditor.setOption('mode', languageModes[language]);
            codeEditor.setValue(sampleCode[language]);
        });

        // Initialize Socket.IO
        const socket = io();
        let isExecuting = false;
        let currentExecutionId = null;

        socket.on('connect', () => {
            console.log('Connected to server');
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from server');
        });

        socket.on('output', (data) => {
            const outputElement = document.getElementById('output');
            const outputText = data.data;

            if (data.type === 'stderr') {
                const span = document.createElement('span');
                span.className = 'stderr';
                span.textContent = outputText;
                outputElement.appendChild(span);
            } else {
                outputElement.appendChild(document.createTextNode(outputText));
            }

            // Auto-scroll to bottom
            outputElement.scrollTop = outputElement.scrollHeight;
        });

        socket.on('execution-complete', (data) => {
            isExecuting = false;
            currentExecutionId = null;
            const outputElement = document.getElementById('output');
            const runBtn = document.getElementById('run-btn');
            const stopBtn = document.getElementById('stop-btn');
            const runSpinner = document.getElementById('run-spinner');
            const inputContainer = document.getElementById('input-container');

            outputElement.classList.remove('running');
            inputContainer.style.display = 'none';
            runSpinner.style.display = 'none';
            runBtn.disabled = false;
            stopBtn.style.display = 'none';

            const statusMsg = data.status === 'success'
                ? '\n✅ Execution completed successfully'
                : `\n❌ Execution failed (exit code: ${data.exitCode})`;

            outputElement.appendChild(document.createTextNode(statusMsg));
            outputElement.scrollTop = outputElement.scrollHeight;
        });

        socket.on('error', (data) => {
            const outputElement = document.getElementById('output');
            outputElement.appendChild(document.createTextNode(`\n❌ Error: ${data.message}\n`));
            isExecuting = false;
            currentExecutionId = null;
        });

        socket.on('execution-start', (data) => {
            currentExecutionId = data.executionId || null;
        });

        // Handle code execution
        document.getElementById('run-btn').addEventListener('click', function () {
            const language = document.getElementById('language').value;
            const code = codeEditor.getValue();
            const outputElement = document.getElementById('output');
            const runSpinner = document.getElementById('run-spinner');
            const stopBtn = document.getElementById('stop-btn');
            const inputContainer = document.getElementById('input-container');
            const interactiveInput = document.getElementById('interactive-input');

            // Validate code
            if (!code.trim()) {
                outputElement.innerText = '❌ Error: Please enter some code to execute';
                return;
            }

            if (isExecuting) {
                return;
            }

            // Clear output and setup UI
            outputElement.textContent = '';
            outputElement.classList.add('running');
            runSpinner.style.display = 'inline-block';
            this.disabled = true;
            stopBtn.style.display = 'inline-block';
            inputContainer.style.display = 'block';
            isExecuting = true;
            currentExecutionId = null;
            interactiveInput.value = '';

            // Emit execution request
            socket.emit('execute-interactive', { language, code });
        });

        // Handle stop button
        document.getElementById('stop-btn').addEventListener('click', function () {
            socket.disconnect();
            setTimeout(() => socket.connect(), 100);

            const outputElement = document.getElementById('output');
            outputElement.appendChild(document.createTextNode('\n\n⏹️ Execution stopped by user\n'));

            isExecuting = false;
            document.getElementById('run-btn').disabled = false;
            document.getElementById('run-spinner').style.display = 'none';
            this.style.display = 'none';
            document.getElementById('input-container').style.display = 'none';
            outputElement.classList.remove('running');
        });

        // Handle interactive input
        const interactiveInput = document.getElementById('interactive-input');
        const sendInputBtn = document.getElementById('send-input-btn');

        function sendInput() {
            if (!isExecuting || !currentExecutionId) return;

            const inputValue = interactiveInput.value;
            if (inputValue !== '') {
                socket.emit('input', { data: inputValue, executionId: currentExecutionId });

                // Show input in output
                const outputElement = document.getElementById('output');
                outputElement.appendChild(document.createTextNode(inputValue + '\n'));
                outputElement.scrollTop = outputElement.scrollHeight;

                interactiveInput.value = '';
            }
        }

        interactiveInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendInput();
            }
        });

        sendInputBtn.addEventListener('click', sendInput);
    </script>
</body>

</html>